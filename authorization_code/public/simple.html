<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Spotify FM</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="http://cdn.binaryjs.com/0/binary.js"></script>
    <script src="howler.js"></script>
  </head>

<body>

  <div class="container-fluid">
    
    <div class="row">
      <div class="col-sm-12">
        <h1>Welcome</h1>
        <button id="pbtn">Play</button>
        <button id="sbtn">Stop</button>
        <div id ="player">
            <audio id="musicplayer" controls></audio>
        </div>
      </div>
    </div>

  </div>

<script>

    // Connect to Binary.js server
    var audioCtx = new AudioContext();
    var source = audioCtx.createBufferSource();
    source.connect( audioCtx.destination);

    var client = new BinaryClient('ws://localhost:9000');
    var play = document.getElementById('pbtn');
    var stop = document.getElementById('sbtn');

    function appendBuffer(buffer1, buffer2) {
      var tmp = new Uint8Array(buffer1.byteLength + buffer2.byteLength);
      tmp.set(new Uint8Array(buffer1), 0);
      tmp.set(new Uint8Array(buffer2), buffer1.byteLength);

      return tmp.buffer;
    }

    play.onclick = function() {
          source.start();
        }

    stop.onclick = function() {
          source.stop();
        }

    client.on('open', function(stream, meta){
    console.log('instanciated');

    });
    /***************************************

    This is how I will eventually preload and play before buffering

    *****************************************/


    // Received new stream from server!
    client.on('stream', function(stream, meta){    
        var parts = [];

        stream.on('data', function(data){

            audioCtx.decodeAudioData(data, function(decodedData) {
              // use the decoded data here
              console.log('decoding audio');
              parts.push(decodedData);
              if( parts.length == 1){
                source.buffer = parts[0];
                source.start();
              }
            });
        });
        stream.on('end', function(){
            //var appended = appendBuffer(parts[0], parts[1]);
            //console.log(appended);
            console.log(parts[0]);
            source.buffer = parts[0];
            
        });


        
        console.log('ready to play');


    });
</script>

</body>
</html>
